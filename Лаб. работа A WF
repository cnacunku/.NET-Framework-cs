using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace NETFramework_cs_10_WF
{
    public partial class NETFramework_cs_10_WF : Form
    {
        public NETFramework_cs_10_WF()
        {
            InitializeComponent();
        }
        private class Employee
        {
            public string FIO { get; set; }

            public string Faculty { get; set; }

            public string Position { get; set; }

            public string Gender { get; set; }

            public DateTime BirthDate { get; set; }

            public string Login { get; set; }

            private string password;

            public string Password
            {
                get => password;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Пароль не может быть пустым.");

                    if (value.Length < 8)
                        throw new Exception("Пароль должен содержать минимум 8 символов.");

                    if (!value.Any(char.IsDigit))
                        throw new Exception("Пароль должен содержать хотя бы одну цифру.");

                    if (!value.Any(char.IsUpper))
                        throw new Exception("Пароль должен содержать хотя бы одну заглавную букву.");

                    if (!value.Any(ch => "!@#$%^&*()_-+=[]{}:;?,.<>/|`~".Contains(ch)))
                        throw new Exception("Пароль должен содержать специальный символ.");

                    if (value.Contains(" "))
                        throw new Exception("Пароль не должен содержать пробелы.");

                    password = value;
                }
            }

            public string AuthCode { get; set; }

            public Employee() { }

            public Employee(string fio, string faculty, string position, string gender, DateTime birth,
                            string login, string password, string authCode)
            {
                FIO = fio;
                Faculty = faculty;
                Position = position;
                Gender = gender;
                BirthDate = birth;
                Login = login;
                Password = password;
                AuthCode = authCode;
            }

            public void SaveToFile(string folderPath)
            {
                if (!Directory.Exists(folderPath))
                    Directory.CreateDirectory(folderPath);

                string filePath = Path.Combine(folderPath, $"{Login}.txt");

                using (StreamWriter sw = new StreamWriter(filePath))
                {
                    sw.WriteLine($"ФИО={FIO}");
                    sw.WriteLine($"Факультет={Faculty}");
                    sw.WriteLine($"Должность={Position}");
                    sw.WriteLine($"Пол={Gender}");
                    sw.WriteLine($"ДатаРождения={BirthDate:yyyy-MM-dd}");
                    sw.WriteLine($"Логин={Login}");
                    sw.WriteLine($"Пароль={Password}");
                    sw.WriteLine($"КодАвторизации={AuthCode}");
                }
            }

            public bool CheckLoginPassword(string login, string password)
            {
                return Login == login && Password == password;
            }

            public bool CheckAuthCode(string code)
            {
                return AuthCode == code;
            }

            public bool CheckKeyFile(string keyFilePath)
            {
                if (!File.Exists(keyFilePath)) return false;

                string fileCode = File.ReadAllText(keyFilePath).Trim();
                return AuthCode == fileCode;
            }
        }

        private void btn2GO_Click(object sender, EventArgs e)
        {
            txt2MSG.Clear();

            try
            {
                if (string.IsNullOrWhiteSpace(txt2FIO.Text))
                    throw new Exception("ФИО не может быть пустым.");

                if (cmb2Faculty.SelectedIndex < 0)
                    throw new Exception("Выберите факультет.");

                if (cmb2Position.SelectedIndex < 0)
                    throw new Exception("Выберите должность.");

                if (cmb2Gender.SelectedIndex < 0)
                    throw new Exception("Выберите пол.");

                if (string.IsNullOrWhiteSpace(txt2Login.Text))
                    throw new Exception("Логин не может быть пустым.");

                if (string.IsNullOrWhiteSpace(txt2Password.Text))
                    throw new Exception("Пароль не может быть пустым.");

                if (string.IsNullOrWhiteSpace(txt2AuthCode.Text))
                    throw new Exception("Код авторизации не может быть пустым.");

                Employee emp = new Employee
                {
                    FIO = txt2FIO.Text.Trim(),
                    Faculty = cmb2Faculty.SelectedItem.ToString(),
                    Position = cmb2Position.SelectedItem.ToString(),
                    Gender = cmb2Gender.SelectedItem.ToString(),
                    BirthDate = dtp2BirthDate.Value,
                    Login = txt2Login.Text.Trim(),
                    Password = txt2Password.Text,
                    AuthCode = txt2AuthCode.Text.Trim()
                };

                string projectRoot = Directory.GetParent(Application.StartupPath).Parent.Parent.FullName;
                string folderPath = Path.Combine(projectRoot, "employees");

                emp.SaveToFile(folderPath);

                txt2MSG.Text = $"Пользователь {emp.FIO} успешно зарегистрирован.\r\nФайл создан: {Path.Combine(folderPath, emp.Login + ".txt")}";
            }
            catch (Exception ex)
            {
                txt2MSG.Text = $"Ошибка: {ex.Message}";
            }
        }
    }
}
